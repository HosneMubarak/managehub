{% extends 'components/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}
    Create Leave Request for Employee - ManageHub
{% endblock %}

{% block styles %}
    <!-- dragula css-->
    <link rel="stylesheet" href="{% static 'assets/libs/dragula/dragula.min.css'%}">
    <style>
        /* Form Section Styling */
        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #0d6efd;
        }

        .form-section:hover {
            border-left-color: #6610f2;
            background: rgba(13, 110, 253, 0.04);
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.1);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .form-section-title {
            color: #495057;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
        }

        .form-section-title i {
            margin-right: 0.5rem;
            color: #0d6efd;
            font-size: 1.2rem;
        }

        /* Dark mode support for form sections */
        [data-theme-mode=dark] .form-section {
            background: rgba(255, 255, 255, 0.02);
            border-left: 4px solid #0d6efd;
        }

        [data-theme-mode=dark] .form-section:hover {
            border-left-color: #6610f2;
            background: rgba(13, 110, 253, 0.08);
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
        }

        [data-theme-mode=dark] .form-section-title {
            color: rgba(255, 255, 255, 0.9);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        /* Required field indicator */
        .required-field::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

        /* Form help text */
        .form-help {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        [data-theme-mode=dark] .form-help {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Progress indicator */
        .progress-indicator {
            background: linear-gradient(90deg, #0d6efd 0%, #6610f2 100%);
            height: 4px;
            border-radius: 2px;
            margin-bottom: 2rem;
        }

        /* Shake animation for balance alerts */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Page Header -->
    <div class="d-flex align-items-center justify-content-between page-header-breadcrumb flex-wrap gap-2">
        <div>
            <nav>
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'leaves:list' %}">Leave Requests</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Create for Employee</li>
                </ol>
            </nav>
            <h1 class="page-title fw-medium fs-18 mb-0">Create Leave Request for Employee</h1>
        </div>
        <div class="btn-list">
            <a href="{% url 'leaves:list' %}" class="btn btn-white btn-wave me-0">
                <i class="ri-arrow-left-line me-1"></i> Back to All Requests
            </a>
        </div>
    </div>
    <!-- Page Header Close -->

    <!-- Start::row-1 -->
    <div class="row">
        <div class="col-xxl-8">
            <form method="post" id="admin-leave-request-form">
                {% csrf_token %}
                <div class="card custom-card">
                    <div class="card-header">
                        <div class="card-title d-flex align-items-center">
                            <i class="ri-admin-line me-2"></i>
                            Create Leave Request for Employee
                        </div>
                        <div class="progress-indicator"></div>
                    </div>
                    <div class="card-body">
                        {% if form.errors %}
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="ri-error-warning-line me-2"></i>
                                <strong>Please correct the following errors:</strong>
                                <ul class="mb-0 mt-2">
                                    {% for field, errors in form.errors.items %}
                                        {% for error in errors %}
                                            <li><strong>{{ field|title }}:</strong> {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endif %}

                        <!-- Employee Selection Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="ri-user-line"></i>
                                Employee Selection
                            </h5>
                            <div class="row">
                                <div class="col-xl-12">
                                    <div class="mb-0">
                                        <label for="{{ form.employee.id_for_label }}" class="form-label required-field">Employee</label>
                                        {{ form.employee }}
                                        {% if form.employee.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.employee.errors }}
                                            </div>
                                        {% endif %}
                                        <div class="form-help">{{ form.employee.help_text }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Leave Type & Duration Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="ri-bookmark-line"></i>
                                Leave Type & Duration
                            </h5>
                            <div class="row">
                                <div class="col-xl-6">
                                    <div class="mb-0">
                                        <label for="{{ form.leave_type.id_for_label }}" class="form-label required-field">Leave Type</label>
                                        {{ form.leave_type }}
                                        {% if form.leave_type.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.leave_type.errors }}
                                            </div>
                                        {% endif %}
                                        <div class="form-help">{{ form.leave_type.help_text }}</div>
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="mb-0">
                                        <label class="form-label">Calculated Duration</label>
                                        <div class="p-3 bg-primary-transparent rounded border">
                                            <div class="d-flex align-items-center justify-content-center">
                                                <span class="h4 mb-0 text-primary" id="calculated-duration">0</span>
                                                <span class="text-muted ms-2">days</span>
                                            </div>
                                            <small class="text-muted d-block text-center mt-1">
                                                Excludes weekends and holidays
                                            </small>
                                        </div>
                                        
                                        <!-- Balance Check Alert -->
                                        <div class="mt-3" id="balance-check-alert" style="display: none;">
                                            <div class="alert alert-warning border-0" id="insufficient-balance-warning" style="display: none;">
                                                <div class="d-flex align-items-center">
                                                    <i class="ri-error-warning-line me-2"></i>
                                                    <div>
                                                        <strong>Insufficient Balance!</strong>
                                                        <div class="mt-1">
                                                            <span id="balance-message">The selected employee doesn't have enough leave balance for this request.</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="alert alert-success border-0" id="sufficient-balance-info" style="display: none;">
                                                <div class="d-flex align-items-center">
                                                    <i class="ri-check-line me-2"></i>
                                                    <div>
                                                        <strong>Balance Available</strong>
                                                        <div class="mt-1">
                                                            <span id="balance-available-message">The selected employee has sufficient balance for this request.</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Date Selection Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="ri-calendar-line"></i>
                                Date Selection
                            </h5>
                            <div class="row">
                                <div class="col-xl-6">
                                    <div class="mb-0">
                                        <label for="{{ form.start_date.id_for_label }}" class="form-label required-field">Start Date</label>
                                        {{ form.start_date }}
                                        {% if form.start_date.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.start_date.errors }}
                                            </div>
                                        {% endif %}
                                        <div class="form-help">{{ form.start_date.help_text }}</div>
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="mb-0">
                                        <label for="{{ form.end_date.id_for_label }}" class="form-label required-field">End Date</label>
                                        {{ form.end_date }}
                                        {% if form.end_date.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.end_date.errors }}
                                            </div>
                                        {% endif %}
                                        <div class="form-help">{{ form.end_date.help_text }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reason & Details Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="ri-message-3-line"></i>
                                Reason & Details
                            </h5>
                            <div class="row">
                                <div class="col-xl-12">
                                    <div class="mb-0">
                                        <label for="{{ form.reason.id_for_label }}" class="form-label required-field">Reason</label>
                                        {{ form.reason }}
                                        {% if form.reason.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.reason.errors }}
                                            </div>
                                        {% endif %}
                                        <div class="form-help">{{ form.reason.help_text }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Guidelines & Information Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="ri-information-line"></i>
                                Guidelines & Information
                            </h5>
                            <div class="row">
                                <div class="col-xl-6">
                                    <div class="alert alert-info border-0">
                                        <h6 class="alert-heading">
                                            <i class="ri-admin-line me-2"></i>Admin Guidelines
                                        </h6>
                                        <ul class="mb-0">
                                            <li class="mb-1">You are creating this request on behalf of the selected employee</li>
                                            <li class="mb-1">The employee will be notified via email</li>
                                            <li class="mb-0">Request will be automatically approved if you have approval rights</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="alert alert-success border-0">
                                        <h6 class="alert-heading">
                                            <i class="ri-check-line me-2"></i>Validation Notes
                                        </h6>
                                        <ul class="mb-0">
                                            <li class="mb-1">Employee's leave balance will be checked automatically</li>
                                            <li class="mb-1">Weekend dates are excluded from calculations</li>
                                            <li class="mb-0">Overlapping requests will be validated</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Footer -->
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'leaves:list' %}" class="btn btn-light btn-wave">
                                <i class="ri-arrow-left-line me-1"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-wave">
                                <i class="ri-add-line me-1"></i>Create Leave Request
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Sidebar -->
        <div class="col-xxl-4">
            <!-- Employee Balance Display -->
            <div class="card custom-card">
                <div class="card-header">
                    <div class="card-title">Employee Leave Balance</div>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4" id="balance-display" style="display: none;">
                        <div class="avatar avatar-xl bg-primary-transparent mx-auto mb-3">
                            <i class="ri-calendar-check-line fs-24"></i>
                        </div>
                        <h4 class="text-primary mb-1" id="available-days-main">-</h4>
                        <p class="text-muted mb-0">Available Days</p>
                    </div>
                    
                    <div class="text-center text-muted" id="no-employee-selected">
                        <div class="avatar avatar-xl bg-light mx-auto mb-3">
                            <i class="ri-user-line fs-24 text-muted"></i>
                        </div>
                        <p class="mb-0">Select an employee to view their leave balance</p>
                    </div>
                    
                    <div class="row text-center" id="balance-breakdown" style="display: none;">
                        <div class="col-6">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <span class="avatar avatar-sm bg-success-transparent me-2">
                                    <i class="ri-check-line fs-14"></i>
                                </span>
                                <div>
                                    <p class="mb-0 fw-medium text-muted fs-12">Used</p>
                                    <p class="fs-14 mb-0 fw-medium" id="used-days-main">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <span class="avatar avatar-sm bg-warning-transparent me-2">
                                    <i class="ri-time-line fs-14"></i>
                                </span>
                                <div>
                                    <p class="mb-0 fw-medium text-muted fs-12">Pending</p>
                                    <p class="fs-14 mb-0 fw-medium" id="pending-days-main">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leave Types Reference -->
            <div class="card custom-card">
                <div class="card-header">
                    <div class="card-title">Leave Types</div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-primary-transparent">{{ leave_types|length }} Types</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column gap-3">
                        {% for leave_type in leave_types %}
                        <div class="d-flex align-items-center gap-2" data-leave-type="{{ leave_type.id }}">
                            <span class="avatar avatar-sm avatar-rounded" style="background-color: {{ leave_type.color_code }};">
                                <span class="text-white fw-medium fs-12">{{ leave_type.code }}</span>
                            </span>
                            <div class="flex-fill">
                                <div class="fw-medium fs-14">{{ leave_type.name }}</div>
                                <div class="d-flex gap-2 mt-1">
                                    {% if leave_type.is_half_day %}
                                        <span class="badge bg-info-transparent fs-11">Half Day</span>
                                    {% endif %}
                                    {% if not leave_type.is_paid %}
                                        <span class="badge bg-warning-transparent fs-11">Unpaid</span>
                                    {% endif %}
                                    {% if leave_type.affects_entitlement %}
                                        <span class="badge bg-secondary-transparent fs-11">Counts Against Entitlement</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted">
                            <i class="ri-calendar-line fs-24 mb-2 d-block"></i>
                            <p class="mb-0">No leave types available</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Quick Tips -->
            <div class="card custom-card">
                <div class="card-header">
                    <div class="card-title">Admin Tips</div>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column gap-3">
                        <div class="d-flex align-items-start gap-2">
                            <span class="avatar avatar-sm bg-primary-transparent">
                                <i class="ri-admin-line fs-14"></i>
                            </span>
                            <div>
                                <div class="fw-medium fs-13 text-primary">Admin Privilege</div>
                                <div class="text-muted fs-12">You can create requests for any employee</div>
                            </div>
                        </div>
                        <div class="d-flex align-items-start gap-2">
                            <span class="avatar avatar-sm bg-info-transparent">
                                <i class="ri-notification-line fs-14"></i>
                            </span>
                            <div>
                                <div class="fw-medium fs-13 text-info">Auto Notification</div>
                                <div class="text-muted fs-12">Employee will be notified via email automatically</div>
                            </div>
                        </div>
                        <div class="d-flex align-items-start gap-2">
                            <span class="avatar avatar-sm bg-success-transparent">
                                <i class="ri-check-line fs-14"></i>
                            </span>
                            <div>
                                <div class="fw-medium fs-13 text-success">Balance Check</div>
                                <div class="text-muted fs-12">System validates employee's available balance</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const employeeSelect = document.getElementById('{{ form.employee.id_for_label }}');
    const leaveTypeSelect = document.getElementById('{{ form.leave_type.id_for_label }}');
    const startDateInput = document.getElementById('{{ form.start_date.id_for_label }}');
    const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
    const form = document.getElementById('admin-leave-request-form');
    
    // Enhanced duration calculation with weekend exclusion
    function calculateDuration() {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (startDate && endDate && startDate <= endDate) {
            let duration = 0;
            const currentDate = new Date(startDate);
            
            // Count business days (exclude weekends: Saturday and Sunday)
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Not Sunday (0) or Saturday (6)
                    duration++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Check if selected leave type is half day
            const selectedOption = leaveTypeSelect.options[leaveTypeSelect.selectedIndex];
            if (selectedOption && (selectedOption.textContent.includes('Half') || selectedOption.textContent.includes('.5'))) {
                duration = duration * 0.5;
            }
            
            document.getElementById('calculated-duration').textContent = duration.toFixed(1);
            
            // Check balance after calculating duration
            checkLeaveBalance(duration);
        } else {
            document.getElementById('calculated-duration').textContent = '0';
            hideBalanceAlerts();
        }
    }
    
    // Check leave balance against requested duration
    function checkLeaveBalance(requestedDays) {
        const employeeSelect = document.getElementById('{{ form.employee.id_for_label }}');
        const leaveTypeSelect = document.getElementById('{{ form.leave_type.id_for_label }}');
        const employeeId = employeeSelect.value;
        const leaveTypeId = leaveTypeSelect.value;
        
        if (!employeeId || !leaveTypeId || !requestedDays || requestedDays <= 0) {
            hideBalanceAlerts();
            return;
        }
        
        // Get selected employee's balance from the sidebar
        const availableDaysElement = document.getElementById('available-days-main');
        if (!availableDaysElement) {
            hideBalanceAlerts();
            return;
        }
        
        const availableDays = parseFloat(availableDaysElement.textContent) || 0;
        
        // Show balance check alerts
        document.getElementById('balance-check-alert').style.display = 'block';
        
        if (requestedDays > availableDays) {
            // Insufficient balance
            document.getElementById('insufficient-balance-warning').style.display = 'block';
            document.getElementById('sufficient-balance-info').style.display = 'none';
            document.getElementById('balance-message').textContent = 
                `Employee needs ${requestedDays.toFixed(1)} days but only has ${availableDays.toFixed(1)} days available.`;
            
            // Disable submit button
            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="ri-error-warning-line me-1"></i>Insufficient Balance';
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-danger');
            }
        } else {
            // Sufficient balance
            document.getElementById('insufficient-balance-warning').style.display = 'none';
            document.getElementById('sufficient-balance-info').style.display = 'block';
            document.getElementById('balance-available-message').textContent = 
                `Requesting ${requestedDays.toFixed(1)} days from employee's ${availableDays.toFixed(1)} available days.`;
            
            // Enable submit button
            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="ri-add-line me-1"></i>Create Leave Request';
                submitBtn.classList.remove('btn-danger');
                submitBtn.classList.add('btn-primary');
            }
        }
    }
    
    // Hide balance alerts
    function hideBalanceAlerts() {
        document.getElementById('balance-check-alert').style.display = 'none';
        document.getElementById('insufficient-balance-warning').style.display = 'none';
        document.getElementById('sufficient-balance-info').style.display = 'none';
        
        // Reset submit button
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="ri-add-line me-1"></i>Create Leave Request';
            submitBtn.classList.remove('btn-danger');
            submitBtn.classList.add('btn-primary');
        }
    }
    
    // Load leave balance for selected employee
    function loadEmployeeBalance() {
        const employeeId = employeeSelect.value;
        const balanceDisplay = document.getElementById('balance-display');
        const noEmployeeSelected = document.getElementById('no-employee-selected');
        const balanceBreakdown = document.getElementById('balance-breakdown');
        
        if (employeeId) {
            // Show loading state
            const availableElement = document.getElementById('available-days-main');
            const usedElement = document.getElementById('used-days-main');
            const pendingElement = document.getElementById('pending-days-main');
            
            // Show loading indicators
            if (availableElement) availableElement.textContent = '...';
            if (usedElement) usedElement.textContent = '...';
            if (pendingElement) pendingElement.textContent = '...';
            
            balanceDisplay.style.display = 'block';
            noEmployeeSelected.style.display = 'none';
            balanceBreakdown.style.display = 'flex';
            
            const params = {
                employee_id: employeeId,
                year: new Date().getFullYear()
            };
            console.log('Fetching balance with params:', params);
            
            fetch('{% url "leaves:balance" %}?' + new URLSearchParams(params), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Update balance display with animation
                if (availableElement) {
                    availableElement.style.opacity = '0.5';
                    setTimeout(() => {
                        availableElement.textContent = data.remaining_days.toFixed(1);
                        availableElement.style.opacity = '1';
                    }, 200);
                }
                if (usedElement) {
                    usedElement.style.opacity = '0.5';
                    setTimeout(() => {
                        usedElement.textContent = data.approved_days.toFixed(1);
                        usedElement.style.opacity = '1';
                    }, 300);
                }
                if (pendingElement) {
                    pendingElement.style.opacity = '0.5';
                    setTimeout(() => {
                        pendingElement.textContent = data.pending_days.toFixed(1);
                        pendingElement.style.opacity = '1';
                    }, 400);
                }
                
                console.log('Balance loaded successfully for employee:', data.employee_name);
            })
            .catch(error => {
                console.error('Error loading balance:', error);
                
                // Show error state
                if (availableElement) availableElement.textContent = 'Error';
                if (usedElement) usedElement.textContent = 'Error';
                if (pendingElement) pendingElement.textContent = 'Error';
                
                // Show error message to user
                showBalanceError('Failed to load employee balance. Please try again.');
            });
        } else {
            // No employee selected - reset to initial state
            balanceDisplay.style.display = 'none';
            noEmployeeSelected.style.display = 'block';
            balanceBreakdown.style.display = 'none';
        }
    }
    
    // Show balance error message
    function showBalanceError(message) {
        const balanceDisplay = document.getElementById('balance-display');
        const noEmployeeSelected = document.getElementById('no-employee-selected');
        
        // Create or update error message
        let errorDiv = document.getElementById('balance-error');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'balance-error';
            errorDiv.className = 'text-center text-danger';
            errorDiv.innerHTML = `
                <div class="avatar avatar-xl bg-danger-transparent mx-auto mb-3">
                    <i class="ri-error-warning-line fs-24"></i>
                </div>
                <p class="mb-0">${message}</p>
            `;
            balanceDisplay.parentNode.appendChild(errorDiv);
        } else {
            errorDiv.querySelector('p').textContent = message;
        }
        
        balanceDisplay.style.display = 'none';
        noEmployeeSelected.style.display = 'none';
        errorDiv.style.display = 'block';
        
        // Hide error after 5 seconds
        setTimeout(() => {
            if (errorDiv) {
                errorDiv.style.display = 'none';
                noEmployeeSelected.style.display = 'block';
            }
        }, 5000);
    }
    
    // Weekend validation function
    function validateWeekends() {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        let hasErrors = false;
        
        // Check start date (Saturday=6, Sunday=0 in JavaScript Date.getDay())
        if (startDate && (startDate.getDay() === 0 || startDate.getDay() === 6)) {
            startDateInput.classList.add('is-invalid');
            let feedback = startDateInput.parentNode.querySelector('.invalid-feedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                startDateInput.parentNode.appendChild(feedback);
            }
            feedback.textContent = 'Leave requests cannot start on weekends (Saturday or Sunday).';
            hasErrors = true;
        } else {
            startDateInput.classList.remove('is-invalid');
        }
        
        // Check end date (Saturday=6, Sunday=0 in JavaScript Date.getDay())
        if (endDate && (endDate.getDay() === 0 || endDate.getDay() === 6)) {
            endDateInput.classList.add('is-invalid');
            let feedback = endDateInput.parentNode.querySelector('.invalid-feedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                endDateInput.parentNode.appendChild(feedback);
            }
            feedback.textContent = 'Leave requests cannot end on weekends (Saturday or Sunday).';
            hasErrors = true;
        } else {
            endDateInput.classList.remove('is-invalid');
        }
        
        return !hasErrors;
    }
    
    // Form validation enhancement
    function validateForm() {
        let isValid = true;
        const requiredFields = [employeeSelect, leaveTypeSelect, startDateInput, endDateInput];
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        // Validate date range
        if (startDateInput.value && endDateInput.value) {
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            
            if (startDate > endDate) {
                endDateInput.classList.add('is-invalid');
                let feedback = endDateInput.parentNode.querySelector('.invalid-feedback');
                if (!feedback) {
                    feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    endDateInput.parentNode.appendChild(feedback);
                }
                feedback.textContent = 'End date must be after or equal to start date.';
                isValid = false;
            }
        }
        
        // Validate weekends
        if (!validateWeekends()) {
            isValid = false;
        }
        
        return isValid;
    }
    
    // Event listeners
    employeeSelect.addEventListener('change', function() {
        console.log('Employee changed to:', this.value);
        // Clear any existing error messages
        const errorDiv = document.getElementById('balance-error');
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
        loadEmployeeBalance();
        // Recalculate duration and check balance after employee change
        calculateDuration();
    });
    
    leaveTypeSelect.addEventListener('change', function() {
        calculateDuration();
    });
    
    startDateInput.addEventListener('change', function() {
        calculateDuration();
        validateWeekends();
    });
    
    endDateInput.addEventListener('change', function() {
        calculateDuration();
        validateWeekends();
    });
    
    // Form submission with validation
    form.addEventListener('submit', function(e) {
        // Check if submit button is disabled (insufficient balance)
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn && submitBtn.disabled) {
            e.preventDefault();
            
            // Show balance error message
            const balanceAlert = document.getElementById('insufficient-balance-warning');
            if (balanceAlert && balanceAlert.style.display !== 'none') {
                balanceAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Add shake animation to alert
                balanceAlert.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    balanceAlert.style.animation = '';
                }, 500);
            }
            return false;
        }
        
        if (!validateForm()) {
            e.preventDefault();
            
            // Show validation message
            const firstInvalidField = form.querySelector('.is-invalid');
            if (firstInvalidField) {
                firstInvalidField.focus();
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
    
    // Real-time validation
    [employeeSelect, leaveTypeSelect, startDateInput, endDateInput].forEach(field => {
        field.addEventListener('blur', validateForm);
        field.addEventListener('input', function() {
            if (this.classList.contains('is-invalid')) {
                validateForm();
            }
        });
    });
    
    // Initial load
    calculateDuration();
});
</script>
{% endblock %}
