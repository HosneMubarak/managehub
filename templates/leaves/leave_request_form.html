{% extends 'components/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}
    {% if object %}Edit Leave Request{% else %}New Leave Request{% endif %} - ManageHub
{% endblock %}

{% block styles %}
    <!-- dragula css-->
    <link rel="stylesheet" href="{% static 'assets/libs/dragula/dragula.min.css'%}">
    <style>
        /* Form Section Styling */
        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #0d6efd;
        }

        .form-section:hover {
            border-left-color: #6610f2;
            background: rgba(13, 110, 253, 0.04);
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.1);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .form-section-title {
            color: #495057;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
        }

        .form-section-title i {
            margin-right: 0.5rem;
            color: #0d6efd;
            font-size: 1.2rem;
        }

        /* Dark mode support for form sections */
        [data-theme-mode=dark] .form-section {
            background: rgba(255, 255, 255, 0.02);
            border-left: 4px solid #0d6efd;
        }

        [data-theme-mode=dark] .form-section:hover {
            border-left-color: #6610f2;
            background: rgba(13, 110, 253, 0.08);
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
        }

        [data-theme-mode=dark] .form-section-title {
            color: rgba(255, 255, 255, 0.9);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        /* Required field indicator */
        .required-field::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

        /* Form help text */
        .form-help {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        [data-theme-mode=dark] .form-help {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Progress indicator */
        .progress-indicator {
            background: linear-gradient(90deg, #0d6efd 0%, #6610f2 100%);
            height: 4px;
            border-radius: 2px;
            margin-bottom: 2rem;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Page Header -->
    <div class="d-flex align-items-center justify-content-between page-header-breadcrumb flex-wrap gap-2">
        <div>
            <nav>
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'leaves:my_requests' %}">Leave Requests</a></li>
                    <li class="breadcrumb-item active" aria-current="page">
                        {% if object %}Edit Request{% else %}New Request{% endif %}
                    </li>
                </ol>
            </nav>
            <h1 class="page-title fw-medium fs-18 mb-0">
                {% if object %}Edit Leave Request{% else %}Request Leave{% endif %}
            </h1>
        </div>
        <div class="btn-list">
            <a href="{% url 'leaves:my_requests' %}" class="btn btn-white btn-wave me-0">
                <i class="ri-arrow-left-line me-1"></i> Back to Requests
            </a>
        </div>
    </div>
    <!-- Page Header Close -->

    <!-- Start::row-1 -->
    <div class="row">
        <div class="col-xxl-8">
            <form method="post" id="leave-request-form">
                {% csrf_token %}
                <div class="card custom-card">
                    <div class="card-header">
                        <div class="card-title d-flex align-items-center">
                            <i class="ri-calendar-add-line me-2"></i>
                            {% if object %}Edit Leave Request{% else %}Create Leave Request{% endif %}
                        </div>
                        <div class="progress-indicator"></div>
                    </div>
                    <div class="card-body">
                        {% if form.errors %}
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="ri-error-warning-line me-2"></i>
                                <strong>Please correct the following errors:</strong>
                                <ul class="mb-0 mt-2">
                                    {% for field, errors in form.errors.items %}
                                        {% for error in errors %}
                                            <li><strong>{{ field|title }}:</strong> {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endif %}

                        <!-- Leave Type & Duration Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="ri-bookmark-line"></i>
                                Leave Type & Duration
                            </h5>
                            <div class="row">
                                <div class="col-xl-6">
                                    <div class="mb-0">
                                        <label for="{{ form.leave_type.id_for_label }}" class="form-label required-field">Leave Type</label>
                                        {{ form.leave_type }}
                                        {% if form.leave_type.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.leave_type.errors }}
                                            </div>
                                        {% endif %}
                                        <div class="form-help">{{ form.leave_type.help_text }}</div>
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="mb-0">
                                        <label class="form-label">Calculated Duration</label>
                                        <div class="p-3 bg-primary-transparent rounded border">
                                            <div class="d-flex align-items-center justify-content-center">
                                                <span class="h4 mb-0 text-primary" id="calculated-duration">0</span>
                                                <span class="text-muted ms-2">days</span>
                                            </div>
                                            <small class="text-muted d-block text-center mt-1">
                                                Excludes weekends and holidays
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Date Selection Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="ri-calendar-line"></i>
                                Date Selection
                            </h5>
                            <div class="row">
                                <div class="col-xl-6">
                                    <div class="mb-0">
                                        <label for="{{ form.start_date.id_for_label }}" class="form-label required-field">Start Date</label>
                                        {{ form.start_date }}
                                        {% if form.start_date.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.start_date.errors }}
                                            </div>
                                        {% endif %}
                                        <div class="form-help">{{ form.start_date.help_text }}</div>
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="mb-0">
                                        <label for="{{ form.end_date.id_for_label }}" class="form-label required-field">End Date</label>
                                        {{ form.end_date }}
                                        {% if form.end_date.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.end_date.errors }}
                                            </div>
                                        {% endif %}
                                        <div class="form-help">{{ form.end_date.help_text }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reason & Details Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="ri-message-3-line"></i>
                                Reason & Details
                            </h5>
                            <div class="row">
                                <div class="col-xl-12">
                                    <div class="mb-0">
                                        <label for="{{ form.reason.id_for_label }}" class="form-label required-field">Reason</label>
                                        {{ form.reason }}
                                        {% if form.reason.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.reason.errors }}
                                            </div>
                                        {% endif %}
                                        <div class="form-help">{{ form.reason.help_text }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Guidelines & Information Section -->
                        <div class="form-section">
                            <h5 class="form-section-title">
                                <i class="ri-information-line"></i>
                                Guidelines & Information
                            </h5>
                            <div class="row">
                                <div class="col-xl-6">
                                    <div class="alert alert-success border-0">
                                        <h6 class="alert-heading">
                                            <i class="ri-check-line me-2"></i>Requirements
                                        </h6>
                                        <ul class="mb-0">
                                            <li class="mb-1">Submit at least 24 hours in advance</li>
                                            <li class="mb-1">Annual leave requires manager approval</li>
                                            <li class="mb-0">Sick leave can be submitted retroactively</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="alert alert-info border-0">
                                        <h6 class="alert-heading">
                                            <i class="ri-calendar-line me-2"></i>Calculation Notes
                                        </h6>
                                        <ul class="mb-0">
                                            <li class="mb-1">Weekends excluded from calculations</li>
                                            <li class="mb-1">Business days only (Mon-Fri)</li>
                                            <li class="mb-0">Cannot start or end on weekends (Fri-Sat)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Footer -->
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'leaves:my_requests' %}" class="btn btn-light btn-wave">
                                <i class="ri-arrow-left-line me-1"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-wave">
                                <i class="ri-{% if object %}edit{% else %}add{% endif %}-line me-1"></i>
                                {% if object %}Update Request{% else %}Submit Request{% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="col-xxl-4">
            <!-- Leave Balance Summary -->
            <div class="card custom-card">
                <div class="card-header">
                    <div class="card-title">Your Leave Balance</div>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="avatar avatar-xl bg-primary-transparent mx-auto mb-3">
                            <i class="ri-calendar-check-line fs-24"></i>
                        </div>
                        <h4 class="text-primary mb-1" id="available-days-main">
                            {% if leave_summary %}{{ leave_summary.remaining_days|floatformat:1 }}{% else %}-{% endif %}
                        </h4>
                        <p class="text-muted mb-0">Available Days</p>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <span class="avatar avatar-sm bg-success-transparent me-2">
                                    <i class="ri-check-line fs-14"></i>
                                </span>
                                <div>
                                    <p class="mb-0 fw-medium text-muted fs-12">Used</p>
                                    <p class="fs-14 mb-0 fw-medium" id="used-days-main">
                                        {% if leave_summary %}{{ leave_summary.approved_days|floatformat:1 }}{% else %}-{% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <span class="avatar avatar-sm bg-warning-transparent me-2">
                                    <i class="ri-time-line fs-14"></i>
                                </span>
                                <div>
                                    <p class="mb-0 fw-medium text-muted fs-12">Pending</p>
                                    <p class="fs-14 mb-0 fw-medium" id="pending-days-main">
                                        {% if leave_summary %}{{ leave_summary.pending_days|floatformat:1 }}{% else %}-{% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leave Types Reference -->
            <div class="card custom-card">
                <div class="card-header">
                    <div class="card-title">Leave Types</div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-primary-transparent">{{ leave_types|length }} Types</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column gap-3">
                        {% for leave_type in leave_types %}
                        <div class="d-flex align-items-center gap-2" data-leave-type="{{ leave_type.id }}">
                            <span class="avatar avatar-sm avatar-rounded" style="background-color: {{ leave_type.color_code }};">
                                <span class="text-white fw-medium fs-12">{{ leave_type.code }}</span>
                            </span>
                            <div class="flex-fill">
                                <div class="fw-medium fs-14">{{ leave_type.name }}</div>
                                <div class="d-flex gap-2 mt-1">
                                    {% if leave_type.is_half_day %}
                                        <span class="badge bg-info-transparent fs-11">Half Day</span>
                                    {% endif %}
                                    {% if not leave_type.is_paid %}
                                        <span class="badge bg-warning-transparent fs-11">Unpaid</span>
                                    {% endif %}
                                    {% if leave_type.affects_entitlement %}
                                        <span class="badge bg-secondary-transparent fs-11">Counts Against Entitlement</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted">
                            <i class="ri-calendar-line fs-24 mb-2 d-block"></i>
                            <p class="mb-0">No leave types available</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Quick Tips -->
            <div class="card custom-card">
                <div class="card-header">
                    <div class="card-title">Quick Tips</div>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column gap-3">
                        <div class="d-flex align-items-start gap-2">
                            <span class="avatar avatar-sm bg-success-transparent">
                                <i class="ri-lightbulb-line fs-14"></i>
                            </span>
                            <div>
                                <div class="fw-medium fs-13 text-success">Plan Ahead</div>
                                <div class="text-muted fs-12">Submit requests 24+ hours in advance for faster approval</div>
                            </div>
                        </div>
                        <div class="d-flex align-items-start gap-2">
                            <span class="avatar avatar-sm bg-info-transparent">
                                <i class="ri-calendar-event-line fs-14"></i>
                            </span>
                            <div>
                                <div class="fw-medium fs-13 text-info">Smart Calculation</div>
                                <div class="text-muted fs-12">Weekends and holidays are automatically excluded</div>
                            </div>
                        </div>
                        <div class="d-flex align-items-start gap-2">
                            <span class="avatar avatar-sm bg-warning-transparent">
                                <i class="ri-edit-line fs-14"></i>
                            </span>
                            <div>
                                <div class="fw-medium fs-13 text-warning">Edit Anytime</div>
                                <div class="text-muted fs-12">Modify pending requests until they're approved</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const leaveTypeSelect = document.getElementById('{{ form.leave_type.id_for_label }}');
    const startDateInput = document.getElementById('{{ form.start_date.id_for_label }}');
    const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
    const form = document.getElementById('leave-request-form');
    
    // Enhanced duration calculation with weekend exclusion
    function calculateDuration() {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (startDate && endDate && startDate <= endDate) {
            let duration = 0;
            const currentDate = new Date(startDate);
            
            // Count business days (exclude weekends: Friday and Saturday)
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                if (dayOfWeek !== 5 && dayOfWeek !== 6) { // Not Friday (5) or Saturday (6)
                    duration++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Check if selected leave type is half day
            const selectedOption = leaveTypeSelect.options[leaveTypeSelect.selectedIndex];
            if (selectedOption && selectedOption.textContent.includes('Half') || selectedOption.textContent.includes('.5')) {
                duration = duration * 0.5;
            }
            
            document.getElementById('calculated-duration').textContent = duration.toFixed(1);
        } else {
            document.getElementById('calculated-duration').textContent = '0';
        }
    }
    
    // Weekend validation function
    function validateWeekends() {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        let hasErrors = false;
        
        // Check start date (Friday=5, Saturday=6 in JavaScript Date.getDay())
        if (startDate && (startDate.getDay() === 5 || startDate.getDay() === 6)) {
            startDateInput.classList.add('is-invalid');
            let feedback = startDateInput.parentNode.querySelector('.invalid-feedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                startDateInput.parentNode.appendChild(feedback);
            }
            feedback.textContent = 'Leave requests cannot start on weekends (Friday or Saturday).';
            hasErrors = true;
        } else {
            startDateInput.classList.remove('is-invalid');
        }
        
        // Check end date (Friday=5, Saturday=6 in JavaScript Date.getDay())
        if (endDate && (endDate.getDay() === 5 || endDate.getDay() === 6)) {
            endDateInput.classList.add('is-invalid');
            let feedback = endDateInput.parentNode.querySelector('.invalid-feedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                endDateInput.parentNode.appendChild(feedback);
            }
            feedback.textContent = 'Leave requests cannot end on weekends (Friday or Saturday).';
            hasErrors = true;
        } else {
            endDateInput.classList.remove('is-invalid');
        }
        
        return !hasErrors;
    }
    
    // Load leave balance when leave type changes
    function loadLeaveBalance() {
        if (leaveTypeSelect.value) {
            fetch('{% url "leaves:balance" %}', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Update main balance display
                const availableElement = document.getElementById('available-days-main');
                const usedElement = document.getElementById('used-days-main');
                const pendingElement = document.getElementById('pending-days-main');
                
                if (availableElement) availableElement.textContent = data.remaining_days.toFixed(1);
                if (usedElement) usedElement.textContent = data.approved_days.toFixed(1);
                if (pendingElement) pendingElement.textContent = data.pending_days.toFixed(1);
            })
            .catch(error => {
                console.error('Error loading balance:', error);
            });
        }
    }
    
    // Form validation enhancement
    function validateForm() {
        let isValid = true;
        const requiredFields = [leaveTypeSelect, startDateInput, endDateInput];
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        // Validate date range
        if (startDateInput.value && endDateInput.value) {
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            
            if (startDate > endDate) {
                endDateInput.classList.add('is-invalid');
                let feedback = endDateInput.parentNode.querySelector('.invalid-feedback');
                if (!feedback) {
                    feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    endDateInput.parentNode.appendChild(feedback);
                }
                feedback.textContent = 'End date must be after or equal to start date.';
                isValid = false;
            }
        }
        
        // Validate weekends
        if (!validateWeekends()) {
            isValid = false;
        }
        
        return isValid;
    }
    
    // Event listeners
    leaveTypeSelect.addEventListener('change', function() {
        loadLeaveBalance();
        calculateDuration();
    });
    
    startDateInput.addEventListener('change', function() {
        calculateDuration();
        validateWeekends();
    });
    
    endDateInput.addEventListener('change', function() {
        calculateDuration();
        validateWeekends();
    });
    
    // Form submission with validation
    form.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            
            // Show validation message
            const firstInvalidField = form.querySelector('.is-invalid');
            if (firstInvalidField) {
                firstInvalidField.focus();
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
    
    // Real-time validation
    [leaveTypeSelect, startDateInput, endDateInput].forEach(field => {
        field.addEventListener('blur', validateForm);
        field.addEventListener('input', function() {
            if (this.classList.contains('is-invalid')) {
                validateForm();
            }
        });
    });
    
    // Initial load
    loadLeaveBalance();
    calculateDuration();
});
</script>
{% endblock %}
